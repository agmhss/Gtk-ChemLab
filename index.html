<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gtk – Virtual Chemistry Lab Class 11 (Step-by-Step + Print)</title>
<style>
  :root{
    --bg:#e6f7f3;--card:#ffffff;--accent:#00796b;--muted:#607d8b;--pill:#e0f7f5;
  }
  *{box-sizing:border-box}
  body{font-family:"Segoe UI",Tahoma,Arial,sans-serif;margin:0;background:linear-gradient(180deg,var(--bg),#f1fbf8);color:#163232;display:flex;justify-content:center;padding:20px;min-height:100vh}
  .app{width:100%;max-width:1100px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 14px 34px rgba(0,0,0,0.12);overflow:hidden}
  header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
  .logo{background:var(--pill);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;width:56px;height:56px}
  h1{margin:0;color:var(--accent);font-size:1.35rem}
  p.lead{margin:0;color:var(--muted);font-size:0.95rem}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.9),#fff);border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.03)}
  .select-group{display:flex;flex-direction:column;gap:10px}
  label.small{font-size:0.85rem;color:var(--muted);margin-bottom:6px}
  select,input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #cfd8d7;font-size:1rem;background:transparent;outline:none}
  .btn{background:linear-gradient(90deg,#00bcd4,#00acc1);color:white;border:none;cursor:pointer;font-weight:700;padding:10px;margin-top:6px}
  .btn.secondary{background:#fff;border:1px solid #cfd8d7;color:#163232;font-weight:600}
  .helpers{font-size:0.86rem;color:var(--muted)}
  .lab-area{display:flex;flex-direction:column;gap:10px;align-items:center}
  .test-tube-wrap{width:220px;display:flex;justify-content:center;margin-top:6px}
  .test-tube{width:84px;height:260px;border:4px solid rgba(90,90,90,0.18);border-radius:38px 38px 46px 46px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.2));position:relative;overflow:hidden;box-shadow:0 8px 18px rgba(0,0,0,0.07),inset 0 6px 18px rgba(255,255,255,0.35);transition:transform .22s}
  .liquid{position:absolute;left:0;right:0;bottom:0;height:56%;background:#add8e6;transition:height .45s,background-color .6s}
  .precip{position:absolute;left:0;right:0;bottom:0;height:0;opacity:0;transition:height 1.1s,opacity .9s,background-color .5s;border-top-left-radius:22px;border-top-right-radius:22px}
  .tube-animate{animation:shake .35s cubic-bezier(.36,.07,.19,.97) both}
  @keyframes shake{10%,90%{transform:translate3d(-2px,0,0)}20%,80%{transform:translate3d(4px,0,0)}30%,50%,70%{transform:translate3d(-6px,0,0)}40%,60%{transform:translate3d(6px,0,0)}}
  .results{width:100%;padding:10px;border-radius:10px;background:linear-gradient(180deg,#f7fffe,#f1fbfa);border:1px dashed rgba(0,120,100,0.06)}
  .equation{font-weight:700;color:#045d53;font-size:1.02rem;background:rgba(224,255,250,0.7);padding:8px;border-radius:6px;margin-bottom:8px;overflow:auto}
  .observation{font-size:0.98rem;color:#333}
  .stepper{margin-top:12px;border-radius:8px;padding:10px;background:#f7fffb;border:1px solid rgba(0,0,0,0.03)}
  .step-title{font-weight:700;color:#0d665f;margin-bottom:6px}
  .step-desc{color:#174a47}
  .step-controls{display:flex;gap:8px;margin-top:10px}
  .meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{background:var(--pill);padding:6px 10px;border-radius:999px;font-weight:600;color:var(--accent);font-size:0.88rem}
  footer{margin-top:12px;font-size:0.82rem;color:var(--muted)}
  .printable { display:none; }
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  /* Print styles */
  @media print {
    body{background:white}
    .app{box-shadow:none;border-radius:0;padding:6mm}
    .no-print{display:none}
    .printable { display:block; }
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Virtual Chemistry Lab V3 with Step-by-Step and Print">
    <header class="no-print">
      <div class="logo" aria-hidden="true"><svg width="34" height="34" viewBox="0 0 24 24"><path fill="#00796b" d="M8 2v6l-6 8h16l-6-8V2z"/></svg></div>
      <div>
        <h1>Gtk – Virtual Chemistry Lab Class 11</h1>
        <p class="lead">Step-by-step textbook tests + printable worksheet · Aqua-Mint theme · 12 salts. </p>
      </div>
    </header>

    <div class="grid">
      <!-- Controls column -->
      <div class="panel no-print" aria-label="Controls">
        <div class="select-group">
          <div>
            <label class="small">Select Cation Salt (Solution)</label>
            <select id="cationSelect" aria-label="Cation selection">
              <option value="">-- Choose Salt / Cation --</option>
              <optgroup label="Lead"><option value="Pb(NO3)2">Lead nitrate — Pb(NO₃)₂</option></optgroup>
              <optgroup label="Copper"><option value="CuSO4">Copper sulfate — CuSO₄</option><option value="CuCO3">Copper carbonate — CuCO₃</option></optgroup>
              <optgroup label="Iron"><option value="FeSO4">Ferrous sulphate — FeSO₄</option><option value="FeCl3">Ferric chloride — FeCl₃</option></optgroup>
              <optgroup label="Aluminium"><option value="Al2(SO4)3">Aluminium sulphate — Al₂(SO₄)₃</option><option value="Al(NO3)3">Aluminium nitrate — Al(NO₃)₃</option></optgroup>
              <optgroup label="Zinc"><option value="ZnSO4">Zinc sulphate — ZnSO₄</option><option value="ZnS">Zinc sulphide — ZnS</option></optgroup>
              <optgroup label="Alkaline / Others"><option value="CaCO3">Calcium carbonate — CaCO₃</option><option value="BaCl2">Barium chloride — BaCl₂</option><option value="MgSO4">Magnesium sulphate — MgSO₄</option><option value="AgNO3">Silver nitrate — AgNO₃</option></optgroup>
            </select>
            <div class="helpers">Salt choice influences liquid color (visual aid).</div>
          </div>

          <div>
            <label class="small">Select Reagent</label>
            <select id="reagentSelect" aria-label="Reagent selection">
              <option value="">-- Choose Reagent --</option>
              <option value="NaOH">Sodium hydroxide — NaOH</option>
              <option value="KOH">Potassium hydroxide — KOH</option>
              <option value="NH4OH">Ammonium hydroxide — NH₄OH</option>
              <option value="KI">Potassium iodide — KI</option>
              <option value="Na2SO4">Sodium sulfate — Na₂SO₄</option>
              <option value="BaCl2">Barium chloride — BaCl₂</option>
              <option value="AgNO3">Silver nitrate — AgNO₃</option>
              <option value="HCl">Hydrochloric acid — HCl</option>
              <option value="Na2CO3">Sodium carbonate — Na₂CO₃</option>
            </select>
            <div class="helpers">Pick reagents used in typical school lab tests.</div>
          </div>

          <div style="display:flex;gap:8px">
            <button id="mixBtn" class="btn">Mix in Test Tube</button>
            <button id="startStepper" class="btn secondary">Start Step-by-Step</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="printBtn" class="btn secondary">Print Worksheet</button>
            <button id="clearLog" class="btn secondary">Clear Log</button>
          </div>
        </div>

        <div class="meta-row" style="margin-top:12px">
          <div class="chip">Step-by-step tests</div>
          <div class="chip">Printable worksheet</div>
          <div class="chip">Textbook-sourced observations</div>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:0.9rem">
          Tip: Use Step-by-Step to replicate textbook analysis sequence (heat → flame → reagents). After running the steps, click Print Worksheet to save a PDF.
        </div>
      </div>

      <!-- Lab / visualization column -->
      <div class="panel lab-area" aria-live="polite">
        <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
          <div><strong>Test tube</strong><div style="font-size:0.86rem;color:var(--muted)">Precipitate grows from bottom; steps show expected textbook observation and rationale.</div></div>
          <div style="text-align:right"><small style="color:var(--muted)">Mix → 0.4s animation</small></div>
        </div>

        <div class="test-tube-wrap">
          <div id="testTube" class="test-tube" role="img" aria-label="Test tube with solution">
            <div id="liquid" class="liquid"></div>
            <div id="precip" class="precip"></div>
          </div>
        </div>

        <div class="results">
          <div id="equation" class="equation">Reactant 1 + Reactant 2 → Products</div>
          <div class="observation"><strong>Observation:</strong> <span id="obsText">Select two chemicals and click Mix or Start Step-by-Step.</span></div>

          <!-- Stepper area -->
          <div id="stepper" class="stepper" aria-hidden="true">
            <div class="step-title" id="stepTitle">Step 1</div>
            <div class="step-desc" id="stepDesc">Step description and expected observation will appear here.</div>
            <div style="margin-top:8px;color:var(--muted);font-size:0.9rem" id="stepRationale">Why this test is used: ...</div>

            <div class="step-controls" style="margin-top:10px">
              <button id="prevStep" class="btn secondary">Previous</button>
              <button id="nextStep" class="btn">Next</button>
              <button id="logStep" class="btn secondary">Log this step</button>
            </div>
            <div style="margin-top:8px;color:var(--muted);font-size:0.9rem">
              Step log entries are stored in a printable worksheet area.
            </div>
          </div>
        </div>

        <footer class="no-print">Reaction data & observations referenced to uploaded textbook. </footer>

        <!-- Printable summary (hidden in UI) -->
        <div id="printArea" class="printable" style="margin-top:12px">
          <h2>Virtual Lab Worksheet</h2>
          <div id="printSummary"></div>
          <hr>
          <div id="printLog"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ----------------- Reaction DB + Step sequences -----------------
   Reactions are the same as V3 (conservative textbook-style).
   Step sequences are arrays of steps per salt (short, textbook-aligned).
   Observations and rationale are based on uploaded textbook. 
------------------------------------------------------------------*/

const reactions = {
  'AgNO3_NaCl': { equation: "AgNO3 + NaCl -> AgCl(s) + NaNO3", observation:"Curdy white precipitate (AgCl) — confirms chloride.", visual:{liquid:'#f7fbfb',precip:'#F5F5F5'} },
  'AgNO3_NaOH': { equation: "2AgNO3 + 2NaOH -> Ag2O(s) + H2O + 2NaNO3", observation:"Brown/black precipitate (Ag2O) appears on standing.", visual:{liquid:'#ffffff',precip:'#8B4513'} },
  'CuSO4_NaOH': { equation: "CuSO4 + 2NaOH -> Cu(OH)2(s) + Na2SO4", observation:"Light/bright blue precipitate (Cu(OH)2).", visual:{liquid:'#bfe9ff',precip:'#00BFFF'} },
  'CuSO4_NH4OH': { equation: "CuSO4 + 4NH4OH -> [Cu(NH3)4]2+ (aq) ...", observation:"Blue ppt dissolves in excess NH4OH to form deep blue complex.", visual:{liquid:'#4f93b6',precip:'#00BFFF'} },
  'Pb(NO3)2_KI': { equation: "Pb(NO3)2 + 2KI -> PbI2(s) + 2KNO3", observation:"Striking yellow crystalline ppt (PbI2).", visual:{liquid:'#fffaf0',precip:'#FFD700'} },
  'Pb(NO3)2_NaOH': { equation: "Pb(NO3)2 + 2NaOH -> Pb(OH)2(s) + 2NaNO3", observation:"Chalky white ppt (Pb(OH)2).", visual:{liquid:'#fffaf0',precip:'#F5F5F5'} },
  'BaCl2_Na2SO4': { equation: "BaCl2 + Na2SO4 -> BaSO4(s) + 2NaCl", observation:"Dense white ppt (BaSO4) — confirms sulfate.", visual:{liquid:'#e6f7ff',precip:'#ffffff'} },
  'FeSO4_NaOH': { equation: "FeSO4 + 2NaOH -> Fe(OH)2(s) + Na2SO4", observation:"Dirty green ppt (Fe(OH)2); oxidises to brown on standing.", visual:{liquid:'#dff2ea',precip:'#3CB371'} },
  'FeCl3_NaOH': { equation: "FeCl3 + 3NaOH -> Fe(OH)3(s) + 3NaCl", observation:"Reddish-brown ppt (Fe(OH)3).", visual:{liquid:'#faf8f6',precip:'#A52A2A'} },
  'Al2(SO4)3_NaOH': { equation: "Al2(SO4)3 + 6NaOH -> 2Al(OH)3(s) + 3Na2SO4", observation:"White gelatinous ppt (Al(OH)3); dissolves in excess NaOH (amphoteric).", visual:{liquid:'#fdfefe',precip:'#F8F8FF'} },
  'ZnSO4_NaOH': { equation: "ZnSO4 + 2NaOH -> Zn(OH)2(s) + Na2SO4", observation:"White ppt (Zn(OH)2) dissolves in excess NaOH (forms zincate).", visual:{liquid:'#f6fbff',precip:'#ffffff'} },
  'ZnS_HCl': { equation: "ZnS + 2HCl -> H2S(g) + ZnCl2", observation:"Rotten-egg smell (H2S) — sulphide present.", visual:{liquid:'#f6fbff'} },
  'CaCO3_HCl': { equation: "CaCO3 + 2HCl -> CaCl2 + CO2(g) + H2O", observation:"Brisk effervescence (CO2); limewater turns milky — carbonate present.", visual:{liquid:'#fffdf2'} },
  'MgSO4_BaCl2': { equation: "MgSO4 + BaCl2 -> BaSO4(s) + MgCl2", observation:"White ppt (BaSO4) forms when testing for sulphate.", visual:{liquid:'#f7fbff',precip:'#ffffff'} },
  'DEFAULT_NR': { equation: "Reactant 1 + Reactant 2 -> No observable change", observation:"No visible change — most species remain soluble / no ppt.", visual:{noReaction:true} }
};

/* Step sequences for the 12 salts — condensed, textbook-style steps & expected outcomes
   Each step: { title, action (short), expected (what you should observe), rationale }.
   These are based on the uploaded textbook tests and common qualitative analysis methods. 
*/
const stepSequences = {
  'Pb(NO3)2': [
    { title:'Colour', action:'Observe the salt/solution colour', expected:'Colourless solution', rationale:'Lead nitrate is typically colourless in solution.' },
    { title:'Heat (test for nitrate)', action:'Gently heat a small amount', expected:'Reddish-brown gas with fishy odour (NO2) — indicates nitrate', rationale:'Nitrate salts often give NO2 on strong heating.' },
    { title:'Flame test', action:'Flame test with HCl paste', expected:'No characteristic flame colour', rationale:'Lead shows no strong characteristic flame color here.' },
    { title:'Add KI (halide test)', action:'Add KI to solution', expected:'Yellow precipitate (PbI2) forms', rationale:'Lead (Pb2+) + I− → PbI2 (yellow) — classical test.' },
    { title:'Add NaOH', action:'Add dilute NaOH', expected:'White precipitate (Pb(OH)2)', rationale:'Lead forms white hydroxide precipitate.' }
  ],
  'CuSO4': [
    { title:'Colour', action:'Observe solution', expected:'Blue solution (hydrated Cu²⁺)', rationale:'Hydrated Cu²⁺ salts are blue.' },
    { title:'Heat (dehydration)', action:'Gently heat the salt', expected:'Blue → White (anhydrous CuSO4) due to loss of water', rationale:'Hydrated copper sulfate loses water on heating.' },
    { title:'Flame test', action:'Flame test on paste', expected:'Bluish-green flame (possible)', rationale:'Copper can impart green/blue tinge during flame tests.' },
    { title:'Add NaOH', action:'Add NaOH', expected:'Light blue precipitate Cu(OH)2; may dissolve in excess NH4OH', rationale:'Classical copper hydroxide test.' },
    { title:'Add BaCl2 (sulfate test)', action:'Add BaCl2', expected:'No white BaSO4 ppt from CuSO4 alone (control)', rationale:'BaCl2 + sulfate gives BaSO4 only if sulfate is present in extract.' }
  ],
  'CuCO3': [
    { title:'Colour', action:'Observe solid', expected:'Greenish solid', rationale:'Basic copper carbonates are green.' },
    { title:'Add HCl', action:'Add dilute HCl', expected:'Effervescence (CO2) and solubilisation; solution turns blue', rationale:'Carbonate reacts with acid to give CO2.' },
    { title:'Add NH4OH', action:'Add ammonia', expected:'Blue solution or no ppt depending on conditions', rationale:'Copper complexes with ammonia.' }
  ],
  'FeSO4': [
    { title:'Colour', action:'Observe solution', expected:'Pale green solution (Fe2+)', rationale:'Ferrous salts are green.' },
    { title:'Add NaOH', action:'Add NaOH', expected:'Dirty green ppt Fe(OH)2; oxidises to brown on standing', rationale:'Fe2+ precipitates as Fe(OH)2 which oxidises.' },
    { title:'Reaction to H2S test', action:'Pass H2S gas', expected:'Black ppt if heavy metals present (Cu etc.)', rationale:'H2S precipitation distinguishes groups.' }
  ],
  'FeCl3': [
    { title:'Colour', action:'Observe solution', expected:'Yellow-brown solution (Fe3+)', rationale:'Ferric salts are brownish/yellow.' },
    { title:'Add NaOH', action:'Add NaOH', expected:'Reddish-brown ppt Fe(OH)3', rationale:'Classic ferric hydroxide precipitate.' },
    { title:'Chromyl chloride test', action:'(For halides) Potassium dichromate + conc. H2SO4', expected:'No red-orange if chloride absent', rationale:'Chromyl chloride indicates chloride.' }
  ],
  'Al2(SO4)3': [
    { title:'Colour', action:'Observe solution', expected:'Colourless', rationale:'Aluminium salts are colourless.' },
    { title:'Add NaOH', action:'Add NaOH', expected:'White gelatinous ppt Al(OH)3; dissolves in excess NaOH', rationale:'Amphoteric nature of Al(OH)3.' },
    { title:'Ammonium molybdate (phosphate test)', action:'Add ammonium molybdate + HNO3', expected:'No canary yellow ppt if phosphate absent', rationale:'Detects phosphate.' }
  ],
  'Al(NO3)3': [
    { title:'Colour', action:'Observe solution', expected:'Colourless', rationale:'Aluminium nitrate is colourless.' },
    { title:'Add NH4OH', action:'Add ammonium hydroxide', expected:'White gelatinous ppt Al(OH)3', rationale:'Standard test for Al3+.' },
    { title:'Confirmatory tests', action:'Sodium peroxide / HCl etc.', expected:'Characteristic reactions for Al', rationale:'Follow textbook group tests for confirmation.' }
  ],
  'ZnSO4': [
    { title:'Colour', action:'Observe solution', expected:'Colourless', rationale:'Zinc salts are colourless.' },
    { title:'Add NaOH', action:'Add NaOH', expected:'White ppt Zn(OH)2; dissolves in excess NaOH (zincate)', rationale:'Zinc hydroxide amphoterism.' },
    { title:'K4[Fe(CN)6] test', action:'Add potassium ferrocyanide', expected:'White ppt soluble in excess NaOH', rationale:'Characteristic test for Zn2+.' }
  ],
  'ZnS': [
    { title:'Add HCl', action:'Add dilute HCl', expected:'H2S gas (rotten egg smell) evolves', rationale:'Sulfides give H2S with acids.' },
    { title:'Confirm H2S', action:'Lead acetate paper', expected:'Turns black if H2S present', rationale:'Classical H2S detection.' }
  ],
  'CaCO3': [
    { title:'Colour', action:'Observe solid', expected:'White', rationale:'Calcium carbonate is white.' },
    { title:'Add HCl', action:'Add dilute HCl', expected:'Effervescence (CO2) — limewater turns milky', rationale:'Carbonate identification.' },
    { title:'Flame test', action:'Flame test', expected:'Brick-red/crimson in flame confirms Ca2+', rationale:'Calcium flame gives brick-red/crimson.' }
  ],
  'BaCl2': [
    { title:'Colour', action:'Observe solution', expected:'Colourless', rationale:'Barium salts are typically colourless.' },
    { title:'Flame test', action:'Flame test', expected:'Apple green flame', rationale:'Barium imparts green to flame.' },
    { title:'Add Na2SO4 (sulfate test)', action:'Add sodium sulfate', expected:'White precipitate BaSO4 — confirms sulphate', rationale:'Ba2+ + SO4^2− → BaSO4 (white).' }
  ],
  'MgSO4': [
    { title:'Colour', action:'Observe solution', expected:'Colourless', rationale:'Magnesium salts colourless.' },
    { title:'Add NH4Cl/NH4OH/NH4H2PO4 (group vi test)', action:'Add group reagents', expected:'White ppt indicates Mg2+ (specific reagents)', rationale:'Group separation confirms Mg2+.' },
    { title:'BaCl2 test', action:'Add BaCl2', expected:'White ppt if sulfate present (BaSO4)', rationale:'Sulfate detection.' }
  ]
};

/* UI elements */
const cationSel = document.getElementById('cationSelect');
const reagentSel = document.getElementById('reagentSelect');
const mixBtn = document.getElementById('mixBtn');
const startStepperBtn = document.getElementById('startStepper');
const printBtn = document.getElementById('printBtn');
const clearLogBtn = document.getElementById('clearLog');

const tube = document.getElementById('testTube');
const liquidEl = document.getElementById('liquid');
const precipEl = document.getElementById('precip');
const eqEl = document.getElementById('equation');
const obsEl = document.getElementById('obsText');

const stepper = document.getElementById('stepper');
const stepTitle = document.getElementById('stepTitle');
const stepDesc = document.getElementById('stepDesc');
const stepRationale = document.getElementById('stepRationale');
const prevStepBtn = document.getElementById('prevStep');
const nextStepBtn = document.getElementById('nextStep');
const logStepBtn = document.getElementById('logStep');

const printArea = document.getElementById('printArea');
const printSummary = document.getElementById('printSummary');
const printLog = document.getElementById('printLog');

/* cation color map (visual aid) */
const cationColor = {
  'AgNO3':'#f7fbfb','CuSO4':'#bfe9ff','CuCO3':'#cdeef0','Pb(NO3)2':'#fffaf0',
  'BaCl2':'#f0fff9','FeSO4':'#e6f9ef','FeCl3':'#fbf3f0','Al2(SO4)3':'#f8fffd',
  'Al(NO3)3':'#fbfffd','ZnSO4':'#f7fbff','ZnS':'#f7fbff','CaCO3':'#fffdf2','MgSO4':'#f7fbff'
};

/* helper: format equation string for display */
function formatChem(txt){
  return String(txt)
    .replace(/->/g,' → ')
    .replace(/([A-Za-z\)\]])(\d+)/g, '$1' + '<sub>$2</sub>')
    .replace(/\(s\)/g,'<i style="font-size:0.85em;color:#666">(s)</i>');
}

/* lookup reaction by both orders */
function lookupReaction(a,b){
  if(!a || !b) return reactions['DEFAULT_NR'];
  const key1 = `${a}_${b}`;
  const key2 = `${b}_${a}`;
  return reactions[key1] || reactions[key2] || reactions['DEFAULT_NR'];
}

/* animate tube & set visuals */
function animateAndShow(result, cationKey){
  // reset
  tube.classList.remove('tube-animate');
  precipEl.style.height='0%'; precipEl.style.opacity='0'; precipEl.style.backgroundColor='transparent';
  liquidEl.style.backgroundColor = cationColor[cationKey] || '#add8e6';

  // animate
  tube.classList.add('tube-animate');

  setTimeout(()=>{
    // visual choices
    if(result.visual && result.visual.noReaction){
      tube.style.boxShadow = '0 0 18px rgba(255,92,92,0.12)';
      setTimeout(()=> tube.style.boxShadow = '0 8px 18px rgba(0,0,0,0.07)',700);
    } else {
      if(result.visual && result.visual.liquid) liquidEl.style.backgroundColor = result.visual.liquid;
      if(result.visual && (result.visual.precip || result.visual.precipitate)){
        const pcolor = result.visual.precip || result.visual.precipitate;
        precipEl.style.backgroundColor = pcolor;
        precipEl.style.height='22%';
        precipEl.style.opacity='1';
      } else {
        // show small default ppt if equation suggests a solid
        if((result.equation||'').includes('(s)')){ precipEl.style.backgroundColor='#ffffff'; precipEl.style.height='18%'; precipEl.style.opacity='1'; }
      }
    }
    eqEl.innerHTML = formatChem(result.equation || '—');
    obsEl.innerHTML = result.observation || '—';
  }, 380);
}

/* Mix button behaviour */
mixBtn.addEventListener('click', ()=>{
  const s = cationSel.value;
  const r = reagentSel.value;
  if(!s || !r){
    eqEl.textContent = 'Select both a salt and a reagent to mix.';
    obsEl.textContent = 'Pick two chemicals, then click Mix.';
    tube.classList.add('tube-animate');
    setTimeout(()=> tube.classList.remove('tube-animate'),600);
    return;
  }
  const result = lookupReaction(s,r);
  animateAndShow(result, s);

  // Log to printable area (summary of single mix)
  lastExperiment = {
    time: new Date().toLocaleString(),
    salt: s, reagent: r, equation: result.equation, observation: result.observation
  };
  updatePrintSummary();
});

/* Stepper logic */
let currentSeq = null;
let currentIndex = 0;
let stepLog = []; // recorded steps for printable worksheet
let lastExperiment = null;

startStepperBtn.addEventListener('click', ()=>{
  const s = cationSel.value;
  if(!s){
    alert('Please select a cation salt to start the step-by-step tests.');
    return;
  }
  // load sequence: if sequence not found, try synonyms (e.g., Pb(NO3)2 -> Pb(NO3)2 key used earlier)
  // Map selected option to sequence key (many keys are exactly the salt id)
  const mapping = {
    'Pb(NO3)2':'Pb(NO3)2','CuSO4':'CuSO4','CuCO3':'CuCO3','FeSO4':'FeSO4','FeCl3':'FeCl3',
    'Al2(SO4)3':'Al2(SO4)3','Al(NO3)3':'Al(NO3)3','ZnSO4':'ZnSO4','ZnS':'ZnS','CaCO3':'CaCO3','BaCl2':'BaCl2','MgSO4':'MgSO4','AgNO3':'AgNO3'
  };
  const key = mapping[s] || s;

  // if no dedicated sequence, use generic fallback
  currentSeq = stepSequences[key] || [
    { title:'Colour', action:'Observe', expected:'Colourless/characteristic', rationale:'Check solution colour.' },
    { title:'Add NaOH', action:'Add NaOH', expected:'Observe for ppt', rationale:'Hydroxide precipitation helps group separation.' }
  ];

  currentIndex = 0;
  stepLog = [];
  showStep();
  stepper.style.display = 'block';
  stepper.setAttribute('aria-hidden','false');
});

/* show specific step */
function showStep(){
  if(!currentSeq) return;
  const s = currentSeq[currentIndex];
  stepTitle.textContent = `${currentIndex+1}. ${s.title}`;
  stepDesc.textContent = `${s.action} — Expected: ${s.expected || '—'}`;
  stepRationale.textContent = `Why this test: ${s.rationale || '—'}`;

  // update Next/Prev disabled states
  prevStepBtn.disabled = (currentIndex === 0);
  nextStepBtn.disabled = (currentIndex === currentSeq.length - 1);
}

/* prev/next handlers */
prevStepBtn.addEventListener('click', ()=>{
  if(currentIndex > 0){ currentIndex--; showStep(); }
});
nextStepBtn.addEventListener('click', ()=>{
  if(currentIndex < currentSeq.length - 1){ currentIndex++; showStep(); }
});

/* log current step (adds to stepLog for printing) */
logStepBtn.addEventListener('click', ()=>{
  if(!currentSeq) return;
  const s = currentSeq[currentIndex];
  const entry = {
    step: currentIndex+1, title: s.title, action: s.action, expected: s.expected, rationale: s.rationale, time: new Date().toLocaleString()
  };
  stepLog.push(entry);
  alert('Step logged to worksheet.');
  updatePrintSummary();
});

/* Print / Worksheet functions */
function updatePrintSummary(){
  // summary: lastExperiment + selected salt/reagent
  let html = '<h3>Experiment Summary</h3>';
  const s = cationSel.value || '—';
  const r = reagentSel.value || '—';
  html += `<p><strong>Salt:</strong> ${s}<br><strong>Reagent:</strong> ${r}</p>`;
  if(lastExperiment){
    html += `<p><strong>Last Mix:</strong> ${lastExperiment.time}<br><strong>Equation:</strong> ${formatChem(lastExperiment.equation)}<br><strong>Observation:</strong> ${lastExperiment.observation}</p>`;
  } else {
    html += `<p>No Mix performed yet.</p>`;
  }
  printSummary.innerHTML = html;

  // step log
  if(stepLog.length){
    let logHtml = '<h3>Step Log</h3><ol>';
    stepLog.forEach(e=>{
      logHtml += `<li><strong>${e.title}:</strong> ${e.action} — Expected: ${e.expected} <br><em>Why:</em> ${e.rationale} <br><small>Logged at ${e.time}</small></li>`;
    });
    logHtml += '</ol>';
    printLog.innerHTML = logHtml;
  } else {
    printLog.innerHTML = '<h3>Step Log</h3><p>No steps logged yet.</p>';
  }
}

/* Print button: opens print dialog with printable area */
printBtn.addEventListener('click', ()=>{
  updatePrintSummary();
  // scroll to print area (ensures printed content appears)
  window.print();
});

/* Clear log */
clearLogBtn.addEventListener('click', ()=>{
  if(confirm('Clear logged steps and last experiment summary?')){ stepLog = []; lastExperiment = null; updatePrintSummary(); alert('Logs cleared.'); }
});

/* small utility: mapping some common mix visuals if user uses Step-by-Step then Mix */
function lookupReaction(a,b){
  if(!a || !b) return reactions['DEFAULT_NR'];
  const key1 = `${a}_${b}`;
  const key2 = `${b}_${a}`;
  return reactions[key1] || reactions[key2] || reactions['DEFAULT_NR'];
}

/* Accessibility: allow Enter in selects to trigger mix */
[cationSel,reagentSel].forEach(el => el.addEventListener('keydown', ev => { if(ev.key === 'Enter'){ mixBtn.click(); }}));

/* End of script */
</script>
</body>
</html>
